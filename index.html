<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HAL Web Demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 1em; }
    #videoPreview { width: 100%; max-height: 300px; background: #333; }
    .panel { 
      border: 1px solid #ccc; 
      padding: 10px; 
      margin-top: 1em; 
      border-radius: 5px; 
      background-color: #f9f9f9;
    }
    .panel h3 { margin: 0; font-size: 1.1em; }
    .panel-content { margin-top: 5px; font-size: 0.9em; }
    button { margin: 0.2em 0; }
    #apiKeyModal {
      display: block; 
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    #apiKeyModalContent {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      text-align: center;
    }
    #apiKeyInput {
      width: 80%;
      padding: 8px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>HAL Web Demo</h1>
  
  <!-- API Key Modal -->
  <div id="apiKeyModal">
    <div id="apiKeyModalContent">
      <h2>Enter API Key</h2>
      <input type="password" id="apiKeyInput" placeholder="API Key" />
      <br/>
      <button id="submitApiKeyBtn">Submit</button>
    </div>
  </div>
  
  <!-- VIDEO PREVIEW & RECORDING -->
  <div>
    <video id="videoPreview" autoplay muted></video><br/>
    <button id="startRecordingBtn" disabled>Start Recording</button>
    <button id="stopRecordingBtn" disabled>Stop Recording</button>
  </div>
  <hr/>
  
  <!-- OR SELECT VIDEO FROM FILE SYSTEM -->
  <div>
    <label for="videoFile">Select Video from Device:</label>
    <input type="file" id="videoFile" accept="video/*" disabled />
  </div>
  <hr/>

  <!-- UPLOAD ACTION -->
  <button id="uploadBtn" disabled>Upload to AWS</button>

  <!-- Message Display Sections -->
  <div id="uploadPanel" class="panel">
    <h3>üì§ Upload Status</h3>
    <div id="uploadMessage" class="panel-content">Waiting for video...</div>
  </div>

  <div id="statusPanel" class="panel">
    <h3>‚è≥ Processing Status</h3>
    <div id="statusMessage" class="panel-content">No status updates yet.</div>
  </div>

  <div id="downloadPanel" class="panel">
    <h3>üì• Download Status</h3>
    <div id="downloadMessage" class="panel-content">Waiting for processing to complete...</div>
  </div>

  <div id="resultsPanel" class="panel" style="display: none;">
    <h3>‚úÖ **Results**</h3>
    <div id="resultsMessage" class="panel-content"></div>
  </div>

  <script>
    const API_VERSION = '0.4.0';
    let API_KEY = null;

    // DOM Elements
    const apiKeyModal = document.getElementById('apiKeyModal');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const submitApiKeyBtn = document.getElementById('submitApiKeyBtn');

    const startRecordingBtn = document.getElementById('startRecordingBtn');
    const stopRecordingBtn = document.getElementById('stopRecordingBtn');
    const videoPreview = document.getElementById('videoPreview');
    const uploadBtn = document.getElementById('uploadBtn');
    const videoFileInput = document.getElementById('videoFile');

    const uploadMessage = document.getElementById('uploadMessage');
    const statusMessage = document.getElementById('statusMessage');
    const downloadMessage = document.getElementById('downloadMessage');
    const resultsPanel = document.getElementById('resultsPanel');
    const resultsMessage = document.getElementById('resultsMessage');

    let mediaRecorder;
    let recordedChunks = [];
    let selectedVideoBlob = null;

    submitApiKeyBtn.onclick = () => {
      const enteredKey = apiKeyInput.value.trim();
      if (enteredKey) {
        API_KEY = enteredKey;
        apiKeyModal.style.display = 'none';
        initializeApp();
      } else {
        alert('API Key is required to proceed.');
      }
    };

    function initializeApp() {
      startRecordingBtn.disabled = false;
      videoFileInput.disabled = false;
      uploadMessage.innerText = 'API Key set. You can now record or select a video to upload.';
    }

    videoFileInput.onchange = () => {
      if (videoFileInput.files.length > 0) {
        selectedVideoBlob = videoFileInput.files[0];
        uploadMessage.innerText = `Selected: ${selectedVideoBlob.name} (size: ${selectedVideoBlob.size} bytes)`;
        uploadBtn.disabled = false;
      }
    };

    uploadBtn.onclick = async () => {
      if (!selectedVideoBlob) return;
      uploadMessage.innerText = 'Requesting upload URL...';
      uploadBtn.disabled = true;

      try {
        const response = await fetch(`https://ue7v1pazxb.execute-api.us-west-2.amazonaws.com/upload/dev/uploaded_video`, {
          method: 'GET',
          headers: { 'x-api-version': API_VERSION, 'x-api-key': API_KEY }
        });

        const { guid, presigned_url } = await response.json();
        uploadMessage.innerText = 'Uploading video...';

        await fetch(presigned_url, {
          method: 'PUT',
          headers: { 'Content-Type': 'video/mp4' },
          body: selectedVideoBlob
        });

        uploadMessage.innerText = 'Upload complete! Checking status...';
        pollStatus(guid);
      } catch (error) {
        uploadMessage.innerText = 'Upload failed: ' + error.message;
      }
    };

    function pollStatus(guid) {
      const interval = setInterval(async () => {
        const response = await fetch(`https://ue7v1pazxb.execute-api.us-west-2.amazonaws.com/status/dev/${guid}`, {
          method: 'GET',
          headers: { 'x-api-key': API_KEY }
        });
        const { status } = await response.json();

        statusMessage.innerText = `Current Status: ${status}`;

        if (status === 'done') {
          clearInterval(interval);
          fetchResults(guid);
        }
      }, 60_000);
    }

    async function fetchResults(guid) {
      const response = await fetch(`https://ue7v1pazxb.execute-api.us-west-2.amazonaws.com/download/dev/${guid}`, {
        method: 'GET',
        headers: { 'x-api-version': API_VERSION, 'x-api-key': API_KEY }
      });
      const { presigned_url } = await response.json();

      const results = await fetch(presigned_url);
      const finalJson = await results.json();

      downloadMessage.innerText = 'Download complete!';
      resultsPanel.style.display = 'block';
      resultsMessage.innerText = JSON.stringify(finalJson, null, 2);
    }
  </script>
</body>
</html>
